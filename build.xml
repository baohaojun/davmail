<project name="DavMail" default="dist" basedir=".">
    <property name="version" value="2.1.1"/>

    <path id="classpath">
        <pathelement location="classes"/>
        <fileset dir="lib">
            <include name="*.jar"/>
        </fileset>
    </path>

    <target name="clean">
        <delete dir="target"/>
        <delete dir="dist"/>
    </target>

    <target name="init">
        <condition property="is.windows">
            <os family="windows"/>
        </condition>
        <mkdir dir="target/classes"/>
    </target>

    <target name="compile" depends="init">
        <mkdir dir="target/classes"/>
        <javac srcdir="src/java" destdir="target/classes" source="1.5" target="1.5" debug="on">
            <classpath>
                <path refid="classpath"/>
            </classpath>
        </javac>
        <copy todir="target/classes">
            <fileset dir="src/java">
                <include name="**/*"/>
                <exclude name="**/*.java"/>
            </fileset>
        </copy>
    </target>

    <target name="dist-nsis" if="is.windows">
        <taskdef name="nsis" classname="net.sf.nsisant.Task">
            <classpath location="lib/nsisant-1.2.jar"/>
        </taskdef>
        <nsis script="davmail-setup.nsi" verbosity="4" out="build.log" noconfig="yes">
            <define name="VERSION" value="${version}"/>
        </nsis>
    </target>

    <target name="dist-deb">
        <taskdef resource="ant_deb_task.properties">
            <classpath location="lib/ant-deb-0.0.1.jar"/>
        </taskdef>
        <desktopentry
            toFile="dist/davmail.desktop"
            name="DavMail"
            comment="DavMail POP/SMTP/Caldav/LDAP Exchange Gateway"
            exec="davmail"
            icon="/usr/share/davmail/davmail.png"
            categories="Office;Email;Network;Calendar;ContactManagement"
        />
        <deb todir="dist"
             package="davmail"
             section="mail"
             depends="sun-java6-jre,libswt-gtk-3.4-java">
            <version upstream="${version}"/>
            <maintainer email="mguessan@free.fr" name="MickaÃ«l Guessant"/>
            <description synopsis="DavMail POP/SMTP/Caldav/LDAP Exchange Gateway">
                Ever wanted to get rid of Outlook ? DavMail is a POP/SMTP/Caldav/LDAP exchange gateway allowing
                users to use any mail/calendar client (e.g. Thunderbird with Lightning) with an Exchange server,
                even from the internet or behind a firewall through Outlook Web Access. DavMail now includes an
                LDAP gateway to Exchange global address book to allow recipient address completion in mail compoze
                window and full calendar support with attendees free/busy display.
                DavMail gateway is implemented in java and should run on any platform. Releases are tested on Windows
                and Linux (Ubuntu). MacOS support is currently limited to server (headless) mode.
                Tested successfully with the Iphone (gateway running on a server).

                http://davmail.sourceforge.net
            </description>
            <tarfileset dir="dist" prefix="usr/share/davmail">
                <include name="lib/*.jar"/>
                <include name="*.jar"/>
                <!-- exclude swt jars from debian package -->
                <exclude name="lib/swt*.jar"/>
            </tarfileset>
            <tarfileset dir="src/bin" prefix="usr/bin" filemode="755">
                <include name="davmail"/>
            </tarfileset>
            <tarfileset dir="dist" prefix="usr/share/davmail">
                <include name="davmail.png"/>
            </tarfileset>
            <tarfileset dir="dist" prefix="usr/share/applications">
                <include name="davmail.desktop"/>
            </tarfileset>
            <tarfileset dir="dist" prefix="usr/share/autostart">
                <include name="davmail.desktop"/>
            </tarfileset>
        </deb>
    </target>

    <target name="dist" depends="compile">
        <delete dir="dist"/>
        <mkdir dir="dist"/>
        <echo file="dist/version.txt" message="${version}"/>
        <jar basedir="target/classes" destfile="dist/davmail.jar">
            <manifest>
                <section name="davmail/">
                    <attribute name="Implementation-Title" value="DavMail Gateway"/>
                    <attribute name="Implementation-Version" value="${version}"/>
                    <attribute name="Implementation-Vendor" value="Mickael Guessant"/>
                </section>
            </manifest>
        </jar>
        <copy todir="dist/lib">
            <fileset dir="lib">
                <include name="*.jar"/>
                <exclude name="nsisant*.jar"/>
                <exclude name="jsmoothgen-ant.jar"/>
                <exclude name="servlet-api.jar"/>
                <exclude name="ant-deb-*.jar"/>
            </fileset>
        </copy>
        <copy file="src/java/tray48.png" tofile="dist/davmail.png"/>
        <copy file="davmail.sh" todir="dist"/>
        <taskdef name="jsmoothgen"
                 classname="net.charabia.jsmoothgen.ant.JSmoothGen"
                 classpathref="classpath"/>
        <jsmoothgen project="davmail.jsmooth" skeletonroot="src/jsmooth/skeletons"/>
        <jsmoothgen project="davmailconsole.jsmooth" skeletonroot="src/jsmooth/skeletons"/>
        <zip file="dist/davmail-${version}.zip">
            <fileset dir="dist">
                <include name="lib/*.jar"/>
                <include name="*.jar"/>
                <include name="davmail.desktop"/>
                <include name="davmail.sh"/>
                <!-- exclude swt jars from platform independent package -->
                <exclude name="lib/swt*.jar"/>
            </fileset>
        </zip>
        <copy todir="dist/web">
            <fileset dir="src/web"/>
        </copy>
        <copy todir="dist/web/WEB-INF/lib">
            <fileset dir="dist">
                <include name="*.jar"/>
            </fileset>
            <fileset dir="dist/lib">
                <include name="*.jar"/>
                <exclude name="nsisant*.jar"/>
                <exclude name="jsmoothgen-ant*.jar"/>
                <exclude name="swt*.jar"/>
            </fileset>
        </copy>
        <jar destfile="dist/davmail-${version}.war">
            <fileset dir="dist/web"/>
        </jar>
        <tar tarfile="dist/davmail-linux-x86-${version}.tgz" compression="gzip">
            <tarfileset prefix="davmail-linux-x86-${version}" dir="dist" filemode="755">
                <include name="davmail.sh"/>
            </tarfileset>
            <tarfileset prefix="davmail-linux-x86-${version}" dir="dist">
                <include name="davmail.desktop"/>
                <include name="lib/*.jar"/>
                <include name="*.jar"/>
                <include name="lib/swt-*-gtk-linux-x86.jar"/>
                <exclude name="lib/swt-*-gtk-linux-x86_64.jar"/>
                <exclude name="lib/swt-*-carbon-macosx.jar"/>
                <exclude name="lib/swt-*-win32-x86.jar"/>
            </tarfileset>
        </tar>
        <tar tarfile="dist/davmail-linux-x86_64-${version}.tgz" compression="gzip">
            <tarfileset prefix="davmail-linux-x86_64-${version}" dir="dist" filemode="755">
                <include name="davmail.sh"/>
            </tarfileset>
            <tarfileset prefix="davmail-linux-x86_64-${version}" dir="dist">
                <include name="davmail.desktop"/>
                <include name="lib/*.jar"/>
                <include name="*.jar"/>
                <include name="lib/swt-*-gtk-linux-x86_64.jar"/>
                <exclude name="lib/swt-*-gtk-linux-x86.jar"/>
                <exclude name="lib/swt-*-carbon-macosx.jar"/>
                <exclude name="lib/swt-*-win32-x86.jar"/>
            </tarfileset>
        </tar>
        <antcall target="dist-nsis"/>
        <antcall target="dist-deb"/>
        <!-- source package -->
        <tar tarfile="dist/davmail-src-${version}.tgz" compression="gzip" longfile="gnu">
            <tarfileset prefix="davmail-src-${version}" dir=".">
                <include name="**/*"/>
                <exclude name="build.log"/>
                <exclude name="dist/**"/>
                <exclude name="target/**"/>
                <exclude name="archive/**"/>
            </tarfileset>
        </tar>
    </target>

</project>
